@using CureLogix.Entity.Concrete
@{
    ViewData["Title"] = "Yapay Zeka Tahmini";
    var medicineList = ViewBag.Medicines as List<Medicine>;
}

<!-- 1. OFFLINE CHART.JS -->
<script src="~/lib/chartjs/chart.min.js"></script>

<section class="content-header"><div class="container-fluid"><h1><i class="fas fa-brain"></i> AI Talep Tahmin Simülasyonu</h1></div></section>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-4 col-md-12">
                <div class="card card-purple card-outline">
                    <div class="card-header"><h3 class="card-title">Simülasyon Parametreleri</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Hedef Şehir</label>
                            <select id="ddlCity" class="form-control">
                                <option value="İstanbul">İstanbul</option>
                                <option value="Ankara">Ankara</option>
                                <option value="İzmir">İzmir</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Analiz Edilecek İlaç</label>
                            <select id="ddlMedicine" class="form-control">
                                <option value="">İlaç Seçiniz...</option>
                                @if (medicineList != null)
                                {
                                    foreach (var item in medicineList)
                                    {
                                        <option value="@item.Name">@item.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <button id="btnAnalyze" type="button" class="btn btn-block bg-gradient-purple"><i class="fas fa-microchip"></i> Analizi Başlat</button>
                    </div>
                </div>
                <div class="card card-dark">
                    <div class="card-header"><h3 class="card-title">Model Çıktısı</h3></div>
                    <div class="card-body text-center">
                        <h5 class="text-muted">Öngörülen Talep</h5>
                        <h1 class="display-4 text-warning font-weight-bold" id="lblPrediction">0</h1>
                        <span class="text-muted">Kutu / Adet</span>
                        <hr /><span class="description-text">GÜVEN SKORU: </span><strong class="text-success" id="lblScore">%0</strong>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 col-md-12">
                <div class="card card-default">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-area mr-1"></i> Regresyon Grafiği</h3></div>
                    <div class="card-body">
                        <div class="chart" style="position: relative; height: 450px;">
                            <canvas id="aiChart" style="min-height: 450px; height: 450px; max-height: 450px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            var ctx = document.getElementById('aiChart').getContext('2d');
            var aiChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['Veri Bekleniyor...'], datasets: [{ label: 'Tüketim', backgroundColor: '#6f42c1', data: [0] }] },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } }
            });

            $("#btnAnalyze").click(function () {
                var cityVal = $("#ddlCity").val();
                var medVal = $("#ddlMedicine").val();
                if (!medVal) { Swal.fire("Uyarı", "Lütfen ilaç seçiniz!", "warning"); return; }

                var btn = $(this); btn.html('İşleniyor...').prop('disabled', true);

                $.ajax({
                    url: '/Ai/Analyze', type: 'POST', data: { city: cityVal, medicineName: medVal },
                    success: function (res) {
                        if (res.Status === "Error") { Swal.fire("Hata", res.Message, "error"); } else {
                            $("#lblPrediction").text(res.PredictedValue); $("#lblScore").text("%" + res.Score);
                            var fullData = res.History; fullData.push(res.PredictedValue);
                            aiChart.data.labels = res.Labels; aiChart.data.datasets[0].data = fullData;
                            var colors = new Array(res.History.length).fill('rgba(210, 214, 222, 1)'); colors[colors.length - 1] = '#6f42c1';
                            aiChart.data.datasets[0].backgroundColor = colors; aiChart.update();
                            Swal.fire("Başarılı", "Analiz Tamamlandı", "success");
                        }
                    },
                    error: function (err) { Swal.fire("Hata", "Sunucu hatası!", "error"); },
                    complete: function () { btn.html('<i class="fas fa-microchip"></i> Analizi Başlat').prop('disabled', false); }
                });
            });
        });
    </script>
}