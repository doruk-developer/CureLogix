@using Microsoft.AspNetCore.Identity
@using CureLogix.Entity.Concrete
@inject UserManager<AppUser> UserManager

@{
    // -----------------------------------------------------------
    // 1. TEMA VE RENK AYARLARI (Cookie'den Okuma)
    // -----------------------------------------------------------
    var themePref = Context.Request.Cookies["ThemePreference"] ?? "light";
    var themeAttr = themePref == "dark" ? "dark" : "light";
    var bodyClass = themePref == "dark" ? "bg-body" : "bg-body-tertiary";
    var sidebarColor = Context.Request.Cookies["SidebarColorPreference"] ?? "primary";

    string hexColor = "#0d6efd";
    string textColor = "#ffffff";

    switch (sidebarColor)
    {
        case "success": hexColor = "#198754"; break;
        case "danger": hexColor = "#dc3545"; break;
        case "warning": hexColor = "#ffc107"; textColor = "#000000"; break;
        case "info": hexColor = "#0dcaf0"; textColor = "#000000"; break;
        case "secondary": hexColor = "#6c757d"; break;
        case "indigo": hexColor = "#6610f2"; break;
        case "pink": hexColor = "#d63384"; break;
        default: hexColor = "#0d6efd"; break;
    }
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - CureLogix</title>

    <link rel="icon" type="image/png" href="~/favicon.png">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
        }

        .app-sidebar-brand {
            background-color: @hexColor !important;
            color: @textColor !important;
        }

        .sidebar-menu .nav-link.active {
            background-color: @hexColor !important;
            color: @textColor !important;
        }

        /* --- VERİTABANI BAĞLANTI SİNYALİ --- */
        .status-dot {
            width: 12px !important;
            height: 12px !important;
            border-radius: 50% !important;
            display: inline-block !important;
            margin-left: 8px;
            vertical-align: middle;
            border: 2px solid rgba(255,255,255,0.4);
            background-color: #6c757d;
            transition: all 0.5s ease;
        }

        .status-online {
            background-color: #28a745 !important;
            box-shadow: 0 0 8px #28a745;
            border-color: transparent !important;
        }

        .status-offline {
            background-color: #dc3545 !important;
            box-shadow: none !important;
            border-color: white !important;
        }

        /* Animasyon Sınıfları */
        .pulse-green {
            animation: pulse-green-anim 2s infinite;
        }

        .fade-in-page {
            animation: fadeInPageAnim 0.5s ease-out forwards;
        }

        .simulation-warning {
            font-size: 0.9rem;
            font-weight: 800;
            color: #dc3545;
            text-transform: uppercase;
            border: 2px dashed #dc3545;
            padding: 4px 12px;
            border-radius: 4px;
            background-color: rgba(220, 53, 69, 0.1);
            animation: blinker-anim 1s linear infinite;
        }

        /* Kilit Stili */
        .system-locked {
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /*
               ✅ UYARI GİDERİCİ: @@keyframes yazımı Visual Studio'da bazen sarı uyarı verir.
               Bunu engellemek için en temiz Razor kaçış yöntemi budur.
            */
       @Html.Raw(@"
            @keyframes pulse-green-anim { 
                0% { box-shadow: 0 0 0 0px rgba(40, 167, 69, 0.7); } 
                100% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 
            }

            @keyframes blinker-anim { 
                50% { opacity: 0.4; } 
            }

            @keyframes slideInDownSmooth { 
                from { opacity: 0; transform: translate3d(0, -20px, 0); } 
                to { opacity: 1; transform: translate3d(0, 0, 0); } 
            }

            /* Yumuşak Sayfa Geçiş Animasyonu */
            @keyframes fadeInPageAnim { 
                from { opacity: 0; transform: translateY(10px); } 
                to { opacity: 1; transform: translateY(0); } 
            }
        ")


        /* --- YAZDIRMA (PRINT) MODU AYARLARI --- */
        @@media print {
            /* 1. Gereksiz her şeyi gizle */
            .app-header,        /* Üst Menü */
            .app-sidebar,       /* Yan Menü */
            .app-footer,        /* Alt Bilgi */
            .content-header,    /* Sayfa Başlığı */
            .btn,               /* Butonlar (Yazdır butonu da dahil) */
            .dataTables_filter, /* Arama Kutusu */
            .dataTables_info,   /* "10 kayıttan 1'i..." yazısı */
            .dataTables_paginate /* Sayfalama numaraları */
            {
                display: none !important;
            }

            /* 2. İçeriği kağıda tam yay */
            .app-wrapper, .app-main, .app-content, .container-fluid, .card, .card-body {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                border: none !important;
                box-shadow: none !important;
                background-color: white !important; /* Arka planı beyaz yap */
                color: black !important;            /* Yazıları siyah yap (Tasarruf) */
            }

            /* 3. Linklerin URL'ini yanına yazma (Bootstrap defaultunu kapat) */
            a[href]:after {
                content: none !important;
            }

            /* 4. Tablo ayarları */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            th, td {
                border: 1px solid #000 !important; /* Hücreleri net çiz */
                padding: 8px !important;
            }
            
            /* Sayfa başlığı ekle (Opsiyonel: Logoyu gösterebiliriz) */
            body::before {
                content: "CureLogix - Resmi Sistem Raporu";
                display: block;
                text-align: center;
                font-weight: bold;
                font-size: 14pt;
                margin-bottom: 20px;
            }
        }

    </style>

    <link rel="stylesheet" href="~/lib/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/theme/css/adminlte.min.css">
    <!-- Driver.js CSS (Tur için gerekli) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css" />
</head>

<body class="layout-fixed sidebar-expand-lg @bodyClass" data-bs-theme="@themeAttr">
    <div class="app-wrapper">

        <!-- A. ÜST MENÜ (NAVBAR) -->
        <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                    <li class="nav-item d-none d-md-block">
                        <span class="nav-link fw-bold">CureLogix Yönetim Paneli</span>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto align-items-center">

                    <!-- 1. VERİTABANI BAĞLANTISI GÖSTERGESİ -->
                    <li class="nav-item d-none d-md-flex align-items-center px-3 border-right">
                        <div id="db-status-container" class="d-flex align-items-center">
                            <small class="text-muted fw-bold">YÜKLENİYOR...</small>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="startTour()">
                            <i class="bi bi-question-circle-fill text-warning"></i> Tur
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="/Settings/Index">
                            @{
                                // --- GÜVENLİ KULLANICI ÇEKME (CS8600 UYARISI GİDERİLDİ) ---
                                CureLogix.Entity.Concrete.AppUser? userObj = null;
                                string nameToShow = User.Identity?.Name ?? "Kullanıcı";
                                try
                                {
                                    userObj = await UserManager.GetUserAsync(User);
                                    if (userObj != null) nameToShow = userObj.NameSurname ?? nameToShow;
                                }
                                catch { }
                            }
                            <i class="fas fa-user-circle fa-lg"></i>
                            <span class="ms-2 fw-bold small">@nameToShow</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- B. SOL MENÜ (SIDEBAR) -->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <div class="sidebar-brand">
                <a href="/" class="brand-link">
                    <i class="fa-solid fa-heart-pulse me-2"></i>
                    <span class="brand-text fw-light">CureLogix</span>
                </a>
            </div>
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu">
                        <li class="nav-header">GENEL</li>
                        <li class="nav-item"><a href="/Ai/Index" class="nav-link"><i class="nav-icon fas fa-brain"></i><p>Yapay Zeka (AI)</p></a></li>
                        <li class="nav-item"><a href="/" class="nav-link active"><i class="nav-icon bi bi-speedometer"></i><p>Dashboard</p></a></li>
                        <li class="nav-item"><a href="/Map/Index" class="nav-link"><i class="nav-icon fas fa-map-marked-alt"></i><p>Salgın Haritası</p></a></li>
                        <li class="nav-item"><a href="/Report/Index" class="nav-link"><i class="nav-icon fas fa-chart-pie"></i><p>Raporlar</p></a></li>
                        <li class="nav-item"><a href="/Audit/Index" class="nav-link"><i class="nav-icon fas fa-user-secret"></i><p>Denetim Günlüğü</p></a></li>

                        <li class="nav-header">OPERASYON</li>
                        <li class="nav-item"><a href="/Hospital/Index" class="nav-link"><i class="nav-icon fa-solid fa-hospital"></i><p>Hastaneler</p></a></li>
                        <li class="nav-item"><a href="/Disease/Index" class="nav-link"><i class="nav-icon fa-solid fa-virus"></i><p>Hastalıklar</p></a></li>
                        <li class="nav-item"><a href="/Doctor/Index" class="nav-link"><i class="nav-icon fa-solid fa-user-doctor"></i><p>Doktorlar</p></a></li>
                        <li class="nav-item"><a href="/Medicine/Index" class="nav-link"><i class="nav-icon fas fa-pills"></i><p>İlaçlar</p></a></li>
                        <li class="nav-item"><a href="/Protocol/Create" class="nav-link"><i class="nav-icon fas fa-file-medical"></i><p>Reçete Oluştur</p></a></li>
                        <li class="nav-item"><a href="/Council/Index" class="nav-link"><i class="nav-icon fas fa-gavel"></i><p>Konsey Kararları</p></a></li>
                        <li class="nav-item"><a href="/Council/ChatRoom" class="nav-link"><i class="nav-icon fas fa-comments"></i><p>Canlı Konsey Odası</p></a></li>
                        <li class="nav-item"><a href="/Document/Index" class="nav-link"><i class="nav-icon fas fa-folder-open"></i><p>Doküman Yönetimi</p></a></li>

                        <li class="nav-header">LOJİSTİK</li>
                        <li class="nav-item"><a href="/CentralStock/Index" class="nav-link"><i class="nav-icon fas fa-boxes-stacked"></i><p>Merkez Depo</p></a></li>
                        <li class="nav-item"><a href="/Supply/Index" class="nav-link"><i class="nav-icon fas fa-truck-medical"></i><p>Talepler</p></a></li>
                        <li class="nav-item"><a href="/CentralStock/Scan" class="nav-link"><i class="nav-icon fas fa-barcode"></i><p>Hızlı Stok Çıkış</p></a></li>
                        <li class="nav-item"><a href="/Waste/Index" class="nav-link"><i class="nav-icon fas fa-biohazard"></i><p>Atık Yönetimi</p></a></li>

                        <li class="nav-header border-top mt-3 pt-2">OTURUM</li>
                        @if (User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <a href="/User/Index" class="nav-link bg-info mb-2 text-white">
                                    <i class="nav-icon fas fa-users-cog"></i><p>Kullanıcı Yönetimi</p>
                                </a>
                            </li>
                        }
                        <li class="nav-item">
                            <a href="/Settings/Index" class="nav-link bg-secondary mb-2 text-white">
                                <i class="nav-icon fas fa-user-cog"></i><p>Hesap Ayarları</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/Login/Logout" class="nav-link bg-danger text-white mt-2">
                                <i class="nav-icon fas fa-power-off"></i><p>Güvenli Çıkış</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- C. İÇERİK ALANI -->
        <main class="app-main">
            <div class="app-content pt-3">
                <!-- Animasyon sınıfını buraya ekledik -->
                <div class="container-fluid fade-in-page">
                    @RenderBody()
                </div>
            </div>
        </main>

        <!-- D. FOOTER -->
        <footer class="app-footer">
            <div class="float-end d-none d-sm-inline">v1.1 (Stable)</div>
            <strong>Copyright &copy; @DateTime.Now.Year CureLogix.</strong>
        </footer>
    </div>

    <!-- D. SCRIPTS -->
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/sweetalert/sweetalert2.all.min.js"></script>
    <script src="~/theme/js/adminlte.js"></script>
    <!-- Driver.js Kütüphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>

    <script>
        // 1. TOAST BİLDİRİMLER (FADE ONLY)
        $(function () {
            var successMessage = '@TempData["Success"]';
            var errorMessage = '@TempData["Error"]';
            if (!successMessage && !errorMessage) return;

            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: null,
                showClass: { popup: 'my-slide-in' }, hideClass: { popup: '' },
                didOpen: (toast) => {
                    var $progressBar = $('<div class="my-custom-progress-bar"></div>');
                    $(toast).append($progressBar);
                    $progressBar.animate({ width: '0%' }, 4000, 'linear');
                    var closeTimer = setTimeout(() => { $(toast).animate({ opacity: 0 }, 1500, () => Swal.close()); }, 4000);
                    $(toast).hover(
                        () => { clearTimeout(closeTimer); $progressBar.stop(true); $(toast).stop(true).css('opacity', 1); },
                        () => { $progressBar.animate({ width: '0%' }, 2000, 'linear'); closeTimer = setTimeout(() => { $(toast).animate({ opacity: 0 }, 1500, () => Swal.close()); }, 2000); }
                    );
                }
            });
            if (successMessage) Toast.fire({ icon: 'success', title: successMessage });
            if (errorMessage) Toast.fire({ icon: 'error', title: errorMessage });
        });

        // 2. VERİTABANI SAĞLIK KONTROLÜ
        function checkSystemPulse() {
            var container = $("#db-status-container");
            $.get("/HealthCheck/DbStatus", function (res) {
                if (res.status === "Demo") {
                    container.html('<div class="simulation-warning"><i class="fas fa-biohazard me-2"></i> TEST VERİSİ</div>');
                    $("button, input, select").prop("disabled", false).removeClass("system-locked");
                } else if (res.status === "Online") {
                    container.html('<small class="text-muted fw-bold">VERİTABANI BAĞLANTISI</small><div class="status-dot status-online pulse-green"></div>');
                    $("button, input, select").prop("disabled", false).removeClass("system-locked");
                } else {
                    container.html('<small class="text-muted fw-bold">VERİTABANI BAĞLANTISI</small><div class="status-dot status-offline"></div>');
                    $("button, input, select").prop("disabled", true).addClass("system-locked");
                }
            }).fail(() => container.html('<small class="text-muted fw-bold text-danger">BAĞLANTI HATASI</small><div class="status-dot status-offline"></div>'));
        }

        $(document).ready(() => {
            checkSystemPulse();
            setInterval(checkSystemPulse, 30000);
        });

        // 3. INTERAKTİF SİSTEM TURU (Driver.js)
        function startTour() {
            // Eğer ana sayfada değilsek, önce ana sayfaya git
            if (window.location.pathname !== "/" && window.location.pathname !== "/Home/Index") {
                if(confirm("Sistem turu Ana Sayfa üzerinden başlamaktadır. Ana sayfaya yönlendirilmek ister misiniz?")) {
                    window.location.href = "/?tour=start"; // URL'e parametre ekle
                }
                return;
            }

            const driver = window.driver.js.driver;
            const driverObj = driver({
                showProgress: true,
                animate: true,
                allowClose: true,
                nextBtnText: 'İleri >',
                prevBtnText: '< Geri',
                doneBtnText: 'Turu Tamamla',
                steps: [
                    { 
                        element: '.brand-link', 
                        popover: { 
                            title: 'CureLogix\'e Hoş Geldiniz!', 
                            description: 'Bu sistem; sağlık lojistiği, kriz yönetimi ve yapay zeka destekli stok takibini tek çatı altında toplar.' 
                        } 
                    },
                    { 
                        element: '#tour-kpi-hospital', 
                        popover: { 
                            title: 'Hastane Ağı', 
                            description: 'Sisteme bağlı tüm hastanelerin anlık durumunu ve toplam sayısını buradan görebilirsiniz.' 
                        } 
                    },
                    { 
                        element: '#tour-kpi-request', 
                        popover: { 
                            title: 'Acil Talepler', 
                            description: 'Hastanelerden gelen ve onay bekleyen ilaç/malzeme talepleri burada listelenir.' 
                        } 
                    },
                    { 
                        element: '#tour-kpi-stock', 
                        popover: { 
                            title: 'Kritik Stok Uyarısı', 
                            description: 'Stoğu tükenmek üzere olan veya SKT\'si yaklaşan (FEFO) ürünler için kırmızı alarm verir.' 
                        } 
                    },
                    { 
                        element: '#tour-chart-main', 
                        popover: { 
                            title: 'Yapay Zeka Destekli Analiz', 
                            description: 'Bölgedeki hastanelerin doluluk oranlarını ve geleceğe yönelik trendleri görselleştirir.' 
                        } 
                    },
                    { 
                        element: '#tour-table-critical', 
                        popover: { 
                            title: 'Hızlı Müdahale Tablosu', 
                            description: 'Acil müdahale gerektiren ilaçlar listelenir. Tek tıkla Merkez Depo\'dan ikmal başlatabilirsiniz.' 
                        } 
                    },
                    { 
                        element: '#tour-logs', 
                        popover: { 
                            title: 'Denetim Günlüğü (Audit Logs)', 
                            description: 'Sistemdeki her işlem (Giriş, Kayıt, Silme) anlık olarak burada ve veritabanında loglanır.' 
                        } 
                    }
                ]
            });

            driverObj.drive();
        }

        // Sayfa yüklendiğinde URL'de 'tour=start' varsa turu otomatik başlat
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('tour') === 'start') {
                // URL'i temizle ve turu başlat
                window.history.replaceState({}, document.title, "/");
                startTour();
            }
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>