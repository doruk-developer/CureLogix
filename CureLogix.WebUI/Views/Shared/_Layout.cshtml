@using Microsoft.AspNetCore.Identity
@using CureLogix.Entity.Concrete
@inject UserManager<AppUser> UserManager

@{
    var themePref = Context.Request.Cookies["ThemePreference"] ?? "light";
    var themeAttr = themePref == "dark" ? "dark" : "light";
    var bodyClass = themePref == "dark" ? "bg-body" : "bg-body-tertiary";
    var sidebarColor = Context.Request.Cookies["SidebarColorPreference"] ?? "primary";
    string hexColor = "#0d6efd"; string textColor = "#ffffff";

    switch (sidebarColor)
    {
        case "success": hexColor = "#198754"; break;
        case "danger": hexColor = "#dc3545"; break;
        case "warning": hexColor = "#ffc107"; break;
        case "info": hexColor = "#0dcaf0"; break;
        case "secondary": hexColor = "#6c757d"; break;
        case "indigo": hexColor = "#6610f2"; break;
        case "pink": hexColor = "#d63384"; break;
        default: hexColor = "#0d6efd"; break;
    }
    if (sidebarColor == "warning" || sidebarColor == "info") { textColor = "#000000"; }
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CureLogix | Sağlık Lojistik Sistemi</title>

    <!--Favicon Referansı-->
    <link rel="icon" type="image/png" href="~/favicon.png">

    <!-- OFFLINE CSS -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
        }</style>

    <!-- İkonlar (Dosyaları indirdiysen yerel yap) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/styles/overlayscrollbars.min.css">

    <!-- AdminLTE & Driver -->
    <link rel="stylesheet" href="~/theme/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css" />

    <style>
        .app-sidebar-brand {
            background-color: @hexColor !important;
            color: @textColor !important;
        }

        .sidebar-menu .nav-link.active {
            background-color: @hexColor !important;
            color: @textColor !important;
            box-shadow: 0 1px 3px rgba(0,0,0,.12);
        }
    </style>
</head>

<body class="layout-fixed sidebar-expand-lg @bodyClass" data-bs-theme="@themeAttr">
    <div class="app-wrapper">
        <!-- NAVBAR -->
        <nav class="app-header navbar navbar-expand bg-body">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" data-lte-toggle="sidebar" href="#"><i class="bi bi-list"></i></a></li>
                    <li class="nav-item d-none d-md-block"><span class="nav-link fw-bold">CureLogix Yönetim Paneli</span></li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="startTour()"><i class="bi bi-question-circle-fill text-warning"></i> Tur</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-lte-toggle="fullscreen"><i class="bi bi-arrows-fullscreen"></i></a></li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="/Settings/Index">
                            @{
                                var currentUser = await UserManager.GetUserAsync(User);
                            }
                            <i class="fas fa-user-circle fa-lg"></i>
                            <span class="d-none d-md-inline ms-2 fw-bold small">@(currentUser?.NameSurname ?? User.Identity?.Name)</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- SIDEBAR -->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <div class="sidebar-brand"><a href="/" class="brand-link"><i class="fa-solid fa-heart-pulse me-2"></i><span class="brand-text fw-light">CureLogix</span></a></div>
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
                        <li class="nav-header">GENEL</li>
                        <li class="nav-item"><a href="/Ai/Index" class="nav-link"><i class="nav-icon fas fa-brain"></i><p>Yapay Zeka (AI)</p></a></li>
                        <li class="nav-item"><a href="/" class="nav-link"><i class="nav-icon bi bi-speedometer"></i><p>Dashboard</p></a></li>
                        <li class="nav-item"><a href="/Map/Index" class="nav-link"><i class="nav-icon fas fa-map-marked-alt"></i><p>Salgın Haritası</p></a></li>
                        <li class="nav-item"><a href="/Report/Index" class="nav-link"><i class="nav-icon fas fa-chart-pie"></i><p>Raporlar</p></a></li>
                        <li class="nav-item"><a href="/Audit/Index" class="nav-link"><i class="nav-icon fas fa-user-secret"></i><p>Denetim Günlüğü</p></a></li>
                        <li class="nav-header">OPERASYON</li>
                        <li class="nav-item"><a href="/Hospital/Index" class="nav-link"><i class="nav-icon fa-solid fa-hospital"></i><p>Hastaneler</p></a></li>
                        <li class="nav-item"><a href="/Disease/Index" class="nav-link"><i class="nav-icon fa-solid fa-user-doctor"></i><p>Hastalıklar</p></a></li>
                        <li class="nav-item"><a href="/Doctor/Index" class="nav-link"><i class="nav-icon fa-solid fa-user-doctor"></i><p>Doktorlar</p></a></li>
                        <li class="nav-item"><a href="/Medicine/Index" class="nav-link"><i class="nav-icon fas fa-pills"></i><p>İlaçlar</p></a></li>
                        <li class="nav-item"><a href="/Protocol/Create" class="nav-link"><i class="nav-icon fas fa-file-medical"></i><p>Reçete Oluştur</p></a></li>
                        <li class="nav-item"><a href="/Council/Index" class="nav-link"><i class="nav-icon fas fa-gavel"></i><p>Konsey Kararları</p></a></li>
                        <li class="nav-item"><a href="/Council/ChatRoom" class="nav-link"><i class="nav-icon fas fa-comments"></i><p>Canlı Konsey Odası</p></a></li>
                        <li class="nav-item"><a href="/Document/Index" class="nav-link"><i class="nav-icon fas fa-folder-open"></i><p>Doküman Yönetimi</p></a></li>
                        <li class="nav-header">LOJİSTİK</li>
                        <li class="nav-item"><a href="/CentralStock/Index" class="nav-link"><i class="nav-icon fas fa-boxes-stacked"></i><p>Merkez Depo</p></a></li>
                        <li class="nav-item"><a href="/Supply/Index" class="nav-link"><i class="nav-icon fas fa-truck-medical"></i><p>Talepler</p></a></li>
                        <li class="nav-item"><a href="/CentralStock/Scan" class="nav-link"><i class="nav-icon fas fa-barcode"></i><p>Hızlı Stok Çıkış</p></a></li>
                        <li class="nav-item"><a href="/Waste/Index" class="nav-link"><i class="nav-icon fas fa-biohazard"></i><p>Atık Yönetimi</p></a></li>
                        <li class="nav-header border-top mt-3 pt-2">OTURUM</li>
                        @if (User.IsInRole("Admin"))
                        {
                            <li class="nav-item"><a href="/User/Index" class="nav-link bg-info mb-2"><i class="nav-icon fas fa-users-cog"></i><p>Kullanıcı Yönetimi</p></a></li>
                        }
                        <li class="nav-item"><a href="/Settings/Index" class="nav-link bg-secondary mb-2"><i class="nav-icon fas fa-user-cog"></i><p>Hesap Ayarları</p></a></li>
                        <li class="nav-item"><a href="/Login/Logout" class="nav-link bg-danger"><i class="nav-icon fas fa-power-off"></i><p>Güvenli Çıkış</p></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- CONTENT -->
        <main class="app-main">
            <div class="app-content-header"><div class="container-fluid"><div class="row"><div class="col-sm-6"><h3 class="mb-0">@ViewData["Title"]</h3></div></div></div></div>
            <div class="app-content"><div class="container-fluid">@RenderBody()</div></div>
        </main>

        <footer class="app-footer"><div class="float-end d-none d-sm-inline">v1.0 (Offline)</div><strong>Copyright &copy; @DateTime.Now.Year CureLogix.</strong></footer>
    </div>

    <!-- OFFLINE SCRIPTS (GÜNCELLENMİŞ YOLLAR) -->
    <!-- 1. jQuery (dist klasöründen çıkarıp ana klasöre aldığını varsayıyorum) -->
    <script src="~/lib/jquery/jquery.min.js"></script>

    <!-- 2. Bootstrap Bundle (AdminLTE 4 İçin Şart) -->
    <script src="~/lib/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- 3. AdminLTE -->
    <script src="~/theme/js/adminlte.js"></script>

    <!-- Diğerleri (İndirdiysen yorumları aç) -->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/browser/overlayscrollbars.browser.es6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>

    <script>
        // Scrollbar Init
        const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
        const Default = { scrollbarTheme: "os-theme-light", scrollbarAutoHide: "leave", scrollbarClickScroll: true };
        document.addEventListener("DOMContentLoaded", function() {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== "undefined") {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, { scrollbars: { theme: Default.scrollbarTheme, autoHide: Default.scrollbarAutoHide, clickScroll: Default.scrollbarClickScroll } });
            }
        });

        // SignalR
        var connection = new signalR.HubConnectionBuilder().withUrl("/generalHub").build();
        connection.start().catch(function (err) { console.error(err.toString()); });
        connection.on("ReceiveCriticalStock", function (message) {
            Swal.fire({ icon: 'error', title: 'KRİTİK STOK ALARMI!', text: message, background: '#fff', color: '#d33' });
        });

        // Driver.js
        function startTour() {
            const driver = window.driver.js.driver;
            const driverObj = driver({
                showProgress: true, animate: true, nextBtnText: 'İleri >', prevBtnText: '< Geri', doneBtnText: 'Tamamla',
                steps: [{ element: '.brand-link', popover: { title: 'Hoş Geldiniz!', description: 'CureLogix Sistemine hoş geldiniz.' } }]
            });
            driverObj.drive();
        }
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>