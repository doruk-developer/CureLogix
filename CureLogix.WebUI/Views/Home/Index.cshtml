@model CureLogix.WebUI.Models.AdvancedDashboardViewModel

@{
    ViewData["Title"] = "Komuta Kontrol Merkezi";
}

<!-- 1. OFFLINE CHART.JS (Yerel) -->
<script src="~/lib/chartjs/chart.min.js"></script>

<section class="content">
    <div class="container-fluid">
        <!-- KPI KARTLARI -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner"><h3>@Model.TotalHospitals</h3><p>Bağlı Hastane</p></div>
                    <div class="icon"><i class="fas fa-hospital-alt"></i></div>
                    <a href="/Hospital/Index" class="small-box-footer">Detaylar <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner"><h3>@Model.TotalDoctors</h3><p>Aktif Personel</p></div>
                    <div class="icon"><i class="fas fa-user-md"></i></div>
                    <a href="/Doctor/Index" class="small-box-footer">Detaylar <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner"><h3>@Model.PendingRequests</h3><p>Bekleyen Talep</p></div>
                    <div class="icon"><i class="fas fa-truck-loading"></i></div>
                    <a href="/Supply/Index" class="small-box-footer">Yönet <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner"><h3>@Model.CriticalStockCount</h3><p>Kritik Stok Kalemi</p></div>
                    <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <a href="/CentralStock/Index" class="small-box-footer">İkmal Yap <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>

        <!-- GRAFİKLER -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-line mr-1"></i> Hastane Doluluk Analizi</h3>
                        <div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div>
                    </div>
                    <div class="card-body">
                        <div class="chart" style="position: relative; height: 350px;">
                            <canvas id="occupancyChart" style="min-height: 350px; height: 350px; max-height: 350px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card card-danger card-outline">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-battery-quarter mr-1"></i> Tükenmek Üzere Olan İlaçlar</h3></div>
                    <div class="card-body p-0 table-responsive" style="height: 300px;">
                        <table class="table table-striped table-valign-middle">
                            <thead><tr><th>Ürün</th><th>Miktar</th><th>Batch No</th><th>İşlem</th></tr></thead>
                            <tbody>
                                @foreach (var item in Model.CriticalMedicines)
                                {
                                    <tr>
                                        <td>@item.MedicineName</td>
                                        <td class="text-danger font-weight-bold">@item.Quantity</td>
                                        <td><small class="badge badge-warning">@item.BatchNo</small></td>
                                        <td><a href="/CentralStock/Entry" class="btn btn-default btn-sm"><i class="fas fa-search"></i></a></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-warning card-outline">
                    <div class="card-header"><h3 class="card-title">Talep/Karşılama Oranı</h3></div>
                    <div class="card-body">
                        <div class="chart" style="position: relative; height: 250px;">
                            <canvas id="requestChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card card-success card-outline">
                    <div class="card-header"><h3 class="card-title">Stok Yeterlilik (Radar)</h3></div>
                    <div class="card-body">
                        <div class="chart" style="position: relative; height: 250px;">
                            <canvas id="radarChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card card-secondary">
                    <div class="card-header"><h3 class="card-title">Son Aktiviteler</h3></div>
                    <div class="card-body p-0">
                        <ul class="products-list product-list-in-card pl-2 pr-2">
                            @foreach (var act in Model.RecentActivities)
                            {
                                <li class="item">
                                    <div class="product-img"><i class="fas fa-history text-muted"></i></div>
                                    <div class="product-info">
                                        <a href="javascript:void(0)" class="product-title">Sistem Logu <span class="badge badge-info float-right">Az Önce</span></a>
                                        <span class="product-description">@act</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
        var userChartType = '@(Context.Request.Cookies["ChartPreference"] ?? "line")';

        // 1. Line/Bar Chart
        var ctxBar = document.getElementById('occupancyChart').getContext('2d');
        var labelsBar = JSON.parse('@Html.Raw(Json.Serialize(Model.HospitalNames))');
        var dataBar = JSON.parse('@Html.Raw(Json.Serialize(Model.OccupancyRates))');

        new Chart(ctxBar, {
            type: userChartType,
            data: {
                labels: labelsBar,
                datasets: [{ label: 'Doluluk Oranı (%)', data: dataBar, backgroundColor: 'rgba(60, 141, 188, 0.5)', borderColor: 'rgba(60, 141, 188, 1)', borderWidth: 2, fill: true }]
            },
            options: { ...commonOptions, scales: { y: { beginAtZero: true, max: 100 } } }
        });

        // 2. Pie Chart
        new Chart(document.getElementById('requestChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Onaylanan', 'Bekleyen', 'Reddedilen'],
                datasets: [{ data: [@Model.ApprovedReq, @Model.WaitingReq, @Model.RejectedReq], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }]
            },
            options: commonOptions
        });

        // 3. Radar Chart
        var labelsRadar = JSON.parse('@Html.Raw(Json.Serialize(Model.MedicineCategories))');
        var dataRadar = JSON.parse('@Html.Raw(Json.Serialize(Model.CategoryStockLevels))');
        new Chart(document.getElementById('radarChart').getContext('2d'), {
            type: 'radar',
            data: {
                labels: labelsRadar,
                datasets: [{ label: 'Yeterlilik Puanı', data: dataRadar, backgroundColor: 'rgba(40, 167, 69, 0.2)', borderColor: '#28a745', pointBackgroundColor: '#28a745' }]
            },
            options: { ...commonOptions, scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
        });
    });
</script>