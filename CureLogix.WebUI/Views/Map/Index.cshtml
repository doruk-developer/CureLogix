@{
    ViewData["Title"] = "Pandemi Isı Haritası";
}

<!-- 1. OFFLINE LEAFLET CSS -->
<link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />

<div class="content-header"><div class="container-fluid"><h1>🌍 Ulusal Doluluk ve Risk Haritası</h1></div></div>

<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header"><h3 class="card-title">Türkiye Geneli Hastane Durumları</h3></div>
            <div class="card-body p-0">
                <div id="pandemicMap" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <!-- 2. OFFLINE LEAFLET JS -->
    <script src="~/lib/leaflet/leaflet.js"></script>

    <script>
        // Sayfa tamamen yüklendiğinde (jQuery hazır olduğunda) çalıştır
        $(document).ready(function () {

            var map = L.map('pandemicMap').setView([39.0, 35.5], 6);

            // Tile Layer (Harita görseli)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; CureLogix GIS'
            }).addTo(map);

            // Verileri Çek
            $.ajax({
                url: '/Map/GetMapData',
                method: 'GET',
                success: function (data) {
                    console.log("Harita Verisi Geldi:", data); // Debug

                    data.forEach(function (point) {
                        if(point.Latitude && point.Longitude) {

                            // Daire (Heatmap etkisi)
                            L.circle([point.Latitude, point.Longitude], {
                                color: point.LevelColor,
                                fillColor: point.LevelColor,
                                fillOpacity: 0.5,
                                radius: 40000
                            }).addTo(map);

                            // Marker ve Popup
                            var popupContent = `<b>${point.HospitalName}</b><br/>Şehir: ${point.City}<br/>Doluluk: <b>%${point.OccupancyRate}</b>`;

                            L.marker([point.Latitude, point.Longitude])
                                .addTo(map)
                                .bindPopup(popupContent);
                        }
                    });
                },
                error: function(err) {
                    console.error("Harita verisi çekilemedi:", err);
                }
            });
        });
    </script>
}